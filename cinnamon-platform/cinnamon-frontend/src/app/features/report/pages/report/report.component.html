<div class="vertical-boxes">
    <div class="box">

        <div>
            In order to save the report as a PDF file, please follow these steps:
            <ol>
                <li>
                    Click on the "Save Report" button below. A new browser window with a print dialog should open.
                </li>
                <li>
                    Select the Destination "Save as PDF".
                </li>
                <li>
                    Check "Background graphics" and optionally uncheck "Headers and footers".
                </li>
                <li>
                    Click on "Save" and close the browser window.
                </li>
            </ol>
        </div>

        <div>
            <button mat-button mat-raised-button color="primary" (click)="printReport()">Save Report</button>
        </div>

    </div>

    <ng-container *ngIf="pageData$ | async as reportData">

        <div class="box" id="report" style="width: fit-content; margin: 0 auto; padding: 0.5in;">

            <!-- This div is printed -->
            <div class="report-root">

                <div class="report-header">
                    <h1>Cinnamon Data Report for <q>{{ reportData.mc.projectName }}</q></h1>
                    <p>Assessment of Resemblance, Utility and Privacy Risks</p>
                    <p>Report Date: {{ reportDate }}, Creator: {{ reportData.mc.reportCreator ?? 'Unknown' }} </p>
                </div>

                <div class="report-section">

                    <div class="report-intro-box">
                        <h2>About this Report</h2>

                        <div class="report-text-block">
                            This report was created with Cinnamon Version {{ reportData.appConfig.version }} and is
                            intended to provide a comprehensive assessment of how well the protected data maintains
                            the analytical value of the original data while mitigating privacy risks.
                        </div>

                        <div class="report-intro-box-list-header">This report provides:</div>

                        <ul>
                            <li class="report-intro-box-list-item">
                                <span class="report-intro-box-list-item-header">Overview of the data protection measures: </span>
                                <span>This report provides information about the configuration and methods used for anonymization and synthetization for the original dataset.</span>
                            </li>
                            <li class="report-intro-box-list-item">
                                <span class="report-intro-box-list-item-header">Data Resemblance: </span>
                                <span>
                                    This report contains an analysis of the quality of the data, by using statistical metrics, describing and comparing the origin dataset and the protected dataset.
                                    A high resemblance indicates that the protected dataset shares the same statistical properties as the original dataset.
                                </span>
                            </li>
                            <li class="report-intro-box-list-item">
                                <span class="report-intro-box-list-item-header">Data Utility: </span>
                                <span>
                                    This report provides an analysis of the machine learning utility for the original and the protected data as part of the data quality assessment.
                                    Comparing the usefulness of the original data against the protected data by utilising downstream machine learning tasks.
                                </span>
                            </li>
                            <li class="report-intro-box-list-item">
                                <span class="report-intro-box-list-item-header">Privacy Risks:</span>
                                <span>
                                    This report provides insights on potential privacy risks associated with the original, and the protected data.
                                    Residual risks might still be present, so the residual privacy risks have to be considered carefully.
                                </span>
                            </li>
                        </ul>
                    </div>

                    <div class="report-intro-box">
                        <h2>Disclaimer</h2>
                        <div class="report-text-block">
                            The analysis and the conclusions contained herein reflect the assessment of the privacy
                            risks and utility of the dataset <strong><q>{{ reportData.mc.projectName }}</q></strong>
                            as analyzed with the Cinnamon tool on {{ reportDate }}. Although this report aims to
                            provide an informed assessment of privacy implications, it does not constitute a
                            guarantee against any form of data privacy breach or residual risks. The decision
                            regarding the use of the data and the associated risks ultimately lies with the user or
                            the organization. It is recommended to use this report in the context of further
                            internal controls and evaluation of data quality. The creator of this report and the
                            developers of Cinnamon assume no liability for direct or indirect damages arising from
                            the use or interpretation of the information contained in this report.
                        </div>
                        <div *ngIf="reportData.mc.contactMail || reportData.mc.contactUrl" class="report-text-block">
                            <span>In case of questions, please</span>
                            <span *ngIf="reportData.mc.contactUrl"> visit <a [href]="reportData.mc.contactUrl"
                                                                             target="_blank">{{ reportData.mc.contactUrl }}</a></span>
                            <span *ngIf="reportData.mc.contactMail && reportData.mc.contactUrl"> or</span>
                            <span *ngIf="reportData.mc.contactMail"> reach out via email to <a
                                [href]="'mailto:' + reportData.mc.contactMail">{{ reportData.mc.contactMail }}</a></span>
                            <span>.</span>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-header report-header-s">
                        Quality Summary: Data Quality and Privacy Risks
                    </div>

                    <div class="report-header2">Data Protection Strategy</div>

                    <div style="display: flex; gap: 20px;">
                        <div style="width: 50%;">
                            <div class="report-text-block">
                                <!-- TODO handling for not applied method -->
                                The Cinnamon Platform applies a two-step data protection by first, anonymizing the
                                dataset and then synthesizing the anonymized data.
                                <br>
                                Overall, <strong>{{ reportData.datasetInfoAnonymized.numberRetainedRows }} of the
                                data records</strong> could be retained during the anonymization.
                                Then <strong>{{ reportData.datasetInfoProtected.numberRows }} records were
                                synthesized.</strong>
                            </div>
                        </div>
                        <div style="width: 50%;">
                            <table class="report-table">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>Original</th>
                                    <th>Protected</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>No. of records (rows)</td>
                                    <td>{{ reportData.datasetInfoOriginal.numberRows }}</td>
                                    <td>{{ reportData.datasetInfoProtected.numberRows }}</td>
                                </tr>
                                <tr>
                                    <td>No. of attributes (columns)</td>
                                    <td>{{ reportData.datasetInfoOriginal.dataConfigurationInfo.numberColumns }}</td>
                                    <td>{{ reportData.datasetInfoProtected.dataConfigurationInfo.numberColumns }}</td>
                                </tr>
                                <tr>
                                    <td>No. of numeric attributes</td>
                                    <td>{{ reportData.datasetInfoOriginal.dataConfigurationInfo.numberNumericColumns }}</td>
                                    <td>{{ reportData.datasetInfoProtected.dataConfigurationInfo.numberNumericColumns }}</td>
                                </tr>
                                <tr>
                                    <td>No. of nominal attributes</td>
                                    <td>{{ reportData.datasetInfoOriginal.dataConfigurationInfo.numberCategoricalColumns }}</td>
                                    <td>{{ reportData.datasetInfoProtected.dataConfigurationInfo.numberCategoricalColumns }}</td>
                                </tr>
                                <tr>
                                    <td>No. of date attributes</td>
                                    <td>{{ reportData.datasetInfoOriginal.dataConfigurationInfo.numberDateColumns }}</td>
                                    <td>{{ reportData.datasetInfoProtected.dataConfigurationInfo.numberDateColumns }}</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <div class="report-header4">Anonymization</div>
                        <div class="report-text-block"
                             [innerHTML]="reportData.reportData['anonymization'].configDescription">
                        </div>
                    </div>

                    <div>
                        <div class="report-header4">Synthetization</div>
                        <div class="report-text-block"
                             [innerHTML]="reportData.reportData['synthetization'].configDescription">
                        </div>
                    </div>

                    <div class="report-header2">Data Protection Results</div>

                    <svg
                        *ngIf="{utilityScoreO: getUtilityScoreOriginal(reportData.statistics.statistics), utilityScoreP: getUtilityScoreProtected(reportData.statistics.statistics)} as graphData"
                        width="800" height="330" xmlns="http://www.w3.org/2000/svg">
                        <!-- Gradient definition -->
                        <defs>
                            <linearGradient id="colorGradient" x1="100%" y1="0%" x2="0%" y2="0%">

                                <ng-container
                                    *ngIf="getColors(reportData.mc.metricConfiguration.colorScheme) as colorScheme">
                                    <ng-container *ngFor="let color of colorScheme; let i = index">
                                        <stop [attr.offset]="i * (100 / (colorScheme.length - 1)) + '%'"
                                              [attr.style]="`stop-color: ${color};`" style="stop-opacity: 1;"/>
                                    </ng-container>
                                </ng-container>
                            </linearGradient>
                        </defs>

                        <!-- Utility Score -->
                        <rect x="20" y="65" width="740" height="30" fill="url(#colorGradient)"/>
                        <text x="10" y="25" font-size="18" font-family="Arial" font-weight="bold">Utility Score:</text>
                        <text x="0" y="85" font-size="14" font-family="Arial">0.0</text>
                        <text x="760" y="85" font-size="14" font-family="Arial">1.0</text>

                        <polygon fill="gray"
                                 [attr.points]="`${calculatePos(graphData.utilityScoreO) - 5},55 ${calculatePos(graphData.utilityScoreO) + 5},55 ${calculatePos(graphData.utilityScoreO)},65`"/>
                        <text [attr.x]="offsetText(graphData.utilityScoreO)" y="47" font-size="14" font-family="Arial">
                            Original Dataset ({{ graphData.utilityScoreO | number: '1.0-1' }})
                        </text>

                        <polygon fill="black"
                                 [attr.points]="`${calculatePos(graphData.utilityScoreP) - 5},105 ${calculatePos(graphData.utilityScoreP) + 5},105 ${calculatePos(graphData.utilityScoreP)},95`"/>
                        <text [attr.x]="offsetText(graphData.utilityScoreP)" y="120" font-size="14" font-family="Arial">
                            Protected Dataset ({{ graphData.utilityScoreP | number: '1.0-1' }})
                        </text>

                        <!-- Privacy Risk Score -->
                        <rect x="20" y="190" width="740" height="30" fill="url(#colorGradient)"/>
                        <text x="10" y="150" font-size="18" font-family="Arial" font-weight="bold">Privacy Score:</text>
                        <text x="0" y="210" font-size="14" font-family="Arial">0.0</text>
                        <text x="760" y="210" font-size="14" font-family="Arial">1.0</text>

                        <polygon [attr.points]="`${riskScoreOX - 5},180 ${riskScoreOX + 5},180 ${riskScoreOX},190`"
                                 fill="gray"/>
                        <text [attr.x]="offsetText(riskScoreO)" x="40" y="175" font-size="14" font-family="Arial">
                            Original Dataset ({{ riskScoreO }})
                        </text>

                        <polygon [attr.points]="`${riskScorePX - 5},230 ${riskScorePX + 5},230 ${riskScorePX},220`"
                                 fill="black"/>
                        <text [attr.x]="offsetText(riskScoreP)" y="245" font-size="14" font-family="Arial">Protected
                            Dataset ({{ riskScoreP }})
                        </text>
                    </svg>

                    <div>
                        <div class="report-header2">Data Quality</div>

                        <div class="report-text-block">
                            The data quality is derived from the resemblance of the statistical properties and the
                            utility of a down-stream machine learning task. Resemblance describes the structural
                            similarity of the protected dataset to the original dataset. Whereas the utility quantifies
                            the overall analytical value of the protected dataset. Scores approaching 1.0 indicate high
                            quality, while scores near 0.0 signify low quality.
                        </div>

                        <div class="d-flex gap-3">
                            <div style="width: 33%;">
                                <div class="report-text-block">
                                    The protected dataset showed over all a <strong>TODO quality</strong>, with a
                                    <strong>Resemblance Score
                                        of {{ reportData.statistics.statistics.Overview.aggregated_metrics[0].overall_resemblance.values.synthetic | number: '1.0-2' }}</strong>,
                                    and a <strong>Machine Learning Utility Score
                                    of {{ reportData.statistics.statistics.Overview.aggregated_metrics[0].overall_utility.values.synthetic | number: '1.0-2' }}</strong>.
                                </div>
                                <div class="report-text-block">
                                    <!-- TODO Set resemblance dynamically -->
                                    The resemblance analysis showed overall <strong>TODO differences</strong> in the
                                    correlation patterns, and <strong>TODO statistical similarities</strong>.
                                </div>
                                <div class="report-text-block">
                                    The statistical similarities showed a <strong>difference of
                                    {{ reportData.numericalAttributes.prop_diff_mean_all | number: '1.0-2' }}%</strong>
                                    overall for the {{ reportData.numericalAttributes.number_all }} numerical
                                    attributes.
                                </div>
                            </div>
                            <div style="width: 67%;">
                                <div class="d-flex">
                                    <div class="m-auto fw-bold">Correlation Patterns</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="d-flex">
                                <div class="m-auto fw-bold">Statistical Similarities</div>
                            </div>
                            <div>
                                <table class="report-table">
                                    <caption>
                                        Statistical properties of mean (standard deviation), absolute difference and
                                        proportional difference of the
                                        first {{ reportData.numericalAttributes.first_attributes.length | numberToText }}
                                        numerical attributes in the dataset.
                                    </caption>
                                    <thead>
                                    <tr>
                                        <th></th>
                                        <th>Original</th>
                                        <th>Protected</th>
                                        <th>Abs. Diff.</th>
                                        <th>Prop. Diff.</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr *ngFor="let numericAttr of reportData.numericalAttributes.first_attributes">
                                        <td>{{ numericAttr.name }}</td>
                                        <td>{{ numericAttr.original_mean | number: '1.0-2' }}
                                            ({{ numericAttr.original_std | number: '1.0-2' }})
                                        </td>
                                        <td>{{ numericAttr.protected_mean | number: '1.0-2' }}
                                            ({{ numericAttr.protected_std | number: '1.0-2' }})
                                        </td>
                                        <td>{{ numericAttr.abs_diff | number: '1.0-2' }}</td>
                                        <td>{{ numericAttr.prop_diff | number: '1.0-2' }}%</td>
                                    </tr>
                                    <tr class="fw-bold">
                                        <td>Total</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>{{ reportData.numericalAttributes.prop_diff_mean_all | number: '1.0-2' }}%
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="report-header2">Data Privacy Risks</div>

                        <div class="report-text-block">
                            Scores approaching 1.0 indicate high privacy, while scores near 0.0 signify low privacy and
                            therefore high potential reidentification risks. The probability of the likelihood of a risk
                            is inverse to the privacy score.
                        </div>

                        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 20px;">
                            <div class="report-metric-card" style="width: 50%; flex: 1; margin: 0 10px 10px 0;">
                                <div style="font-weight: bold;">Identified High Privacy Risk</div>
                                <div style="font-size: 24px; color: #3498db;">87%</div>
                                <div style="font-size: 14px; color: #7f8c8d;">Statistical similarity to original data
                                </div>
                            </div>
                            <div class="report-metric-card" style="width: 50%; flex: 1; margin: 0 10px 10px 0;">
                                <div style="font-weight: bold;">Identified Low Privacy Risk</div>
                                <div style="font-size: 24px; color: #3498db;">92%</div>
                                <div style="font-size: 14px; color: #7f8c8d;">Analytical accuracy compared to original
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="report-section">
                    <div class="report-header report-header-s">
                        Details for each attribute
                    </div>

                    <div *ngFor="let attributeStatistics of reportData.statistics.statistics!.resemblance.attributes">
                        <div class="report-header2">
                            Attribute: {{ attributeStatistics.attribute_information.name }}
                        </div>

                        <div>
                            <div class="report-header4">Attribute Information</div>

                            <div class="d-flex w-100 gap-3">
                                <div>
                                    <span class="fw-bold">Index:</span>
                                    <span> {{ attributeStatistics.attribute_information.index }}</span>
                                </div>
                                <div>
                                    <span class="fw-bold">Name:</span>
                                    <span> {{ attributeStatistics.attribute_information.name }}</span>
                                </div>
                                <div>
                                    <span class="fw-bold">Type:</span>
                                    <span> {{ attributeStatistics.attribute_information.type }}</span>
                                </div>
                                <div>
                                    <span class="fw-bold">Scale:</span>
                                    <span> {{ attributeStatistics.attribute_information.scale }}</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="report-header4">Resemblance Analysis</div>

                            <div class="report-keep-together">
                                <app-data-inspection-metric-table [attributeStatistics]="attributeStatistics"
                                                                  datasetDisplayName="Protected"
                                                                  [tableType]="MetricTableType.COMPARISON">
                                </app-data-inspection-metric-table>
                            </div>


                        </div>

                        <ng-container *ngIf="attributeStatistics.plot.histogram">
                            <div class="report-header4">
                                Histogram
                            </div>
                            <app-chart-frequency #chart
                                                 [colorScheme]="reportData.mc.metricConfiguration.colorScheme"
                                                 [data]="attributeStatistics.plot.histogram!" [limit]="null"
                                                 [simple]="false" originalSeriesLabel="Original"
                                                 syntheticSeriesLabel="Protected">
                            </app-chart-frequency>
                        </ng-container>
                        <ng-container *ngIf="attributeStatistics.plot.visualize_columnwise_correlations">
                            <div class="report-header4">
                                Correlation
                            </div>
                            <app-chart-correlation #chart [colorScheme]="reportData.mc.metricConfiguration.colorScheme"
                                                   [columnConfiguration]="attributeStatistics.attribute_information"
                                                   [data]="attributeStatistics.plot.visualize_columnwise_correlations!"
                                                   originalSeriesLabel="Original" [showVisualMap]="false"
                                                   [simple]="false" syntheticSeriesLabel="Protected">
                            </app-chart-correlation>
                        </ng-container>
                        <ng-container *ngIf="attributeStatistics.plot.frequency_plot">
                            <div class="report-header4">
                                Frequency
                            </div>
                            <app-chart-frequency #chart
                                                 [colorScheme]="reportData.mc.metricConfiguration.colorScheme"
                                                 [data]="attributeStatistics.plot.frequency_plot!" [limit]="null"
                                                 [simple]="false" originalSeriesLabel="Original"
                                                 syntheticSeriesLabel="Protected">
                            </app-chart-frequency>
                        </ng-container>
                        <ng-container *ngIf="attributeStatistics.plot.density">
                            <div class="report-header4">
                                Density
                            </div>
                            <app-chart-density #chart [colorScheme]="reportData.mc.metricConfiguration.colorScheme"
                                               [columnConfiguration]="attributeStatistics.attribute_information"
                                               [data]="attributeStatistics.plot.density!" originalSeriesLabel="Original"
                                               [simple]="false" syntheticSeriesLabel="Protected">
                            </app-chart-density>
                        </ng-container>
                    </div>

                </div>

                <div
                    style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; color: #7f8c8d; font-size: 14px;">
                    <p>Privacy Report | Prepared: 01.01.2025</p>
                    <p>Confidential - For Internal Use Only</p>
                </div>

            </div>
        </div>

    </ng-container>
</div>
