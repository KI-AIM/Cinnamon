<!-- Error -->
<app-info-card [hidden]="evaluationService.error === null" typeClass="card-failure">
    <div>{{ evaluationService.error }}</div>
</app-info-card>

<div class="mt-2">
    <button type="submit" class="me-2" mat-raised-button color="primary" [disabled]="evaluationService.disabled"
            (click)="evaluationService.start()">
        Start
    </button>

    <button type="submit" class="me-2" mat-raised-button color="primary" [disabled]="!evaluationService.disabled"
            (click)="evaluationService.cancel()">
        Cancel Algorithm
    </button>

    <button type="submit" mat-raised-button color="primary" (click)="downloadResult()">
        Download
    </button>
</div>

<div *ngIf="(stage$ | async) as status">

    <div class="mb-2">
        <h2 class="me-2" style="display: inline;">Status</h2>
        <span class="status mt-2" [ngClass]="evaluationService.status.status">
        <span>{{ evaluationService.status.status.replace("_", " ") }}</span>
    </span>
    </div>

    <mat-accordion *ngIf="evaluationService.status.processes.length > 0">
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>Technical Evaluation</mat-panel-title>
                <mat-panel-description>
                <span class="status mt-2"
                      [ngClass]="evaluationService.status.processes[0].externalProcessStatus">
                    <span>{{ evaluationService.status.processes[0].externalProcessStatus.replace("_", " ") }}</span>
                </span>
                </mat-panel-description>
            </mat-expansion-panel-header>

            <div>
                <ng-template *ngIf="evaluationService.technicalEvaluationStatus !== null">
                    {{ evaluationService.technicalEvaluationStatus }}
                </ng-template>

                <div
                    *ngIf="evaluationService.status.processes[0].externalProcessStatus == ProcessStatus.FINISHED; else anonNoData">
                    <app-data-inspection sourceProcess="TECHNICAL_EVALUATION" mainData="synthetic"
                                         [processingSteps]="evaluationService.processSteps"></app-data-inspection>
                </div>
                <ng-template #anonNoData>
                    <div>
                        No Data Available
                    </div>
                </ng-template>
            </div>

        </mat-expansion-panel>
        <mat-expansion-panel *ngIf="(statistics$ | async)?.utility as utility">
            <mat-expansion-panel-header>
                <mat-panel-title> {{utility.display_name}} </mat-panel-title>
                <mat-panel-description>
                    {{ utility.description }}
                </mat-panel-description>
            </mat-expansion-panel-header>

            <div>
                <button mat-flat-button [matMenuTriggerFor]="colorLegend" class="flat-mat-form-button ms-auto">Legend</button>
                <div *ngFor="let abc of utility.methods | keyvalue" class="mb-2 pt-2 border-top border-1">

                    <div style="display: flex;">
                        <span style="font-size: 1.2rem; margin-right: 0.2rem;"> {{ abc.value.display_name }} </span>

                        <a title="Show Metric Information" style="vertical-align: middle;"
                           (click)="metricInfoTableComponent.open(abc.value)">
                            <mat-icon fontIcon="info"></mat-icon>
                        </a>

                    </div>

                    <div *ngIf="(abc.value | instanceOf:UtilityMetricData2) as data2">
                        <div class="predictions">
                            <div>
                                <div>Real</div>
                            </div>
                            <ng-container *ngTemplateOutlet="utilityMetricTable; context: {predictions: data2.real.predictions}">
                            </ng-container>
                        </div>
                        <div class="predictions">
                            <div>
                                <div>Synthetic</div>
                            </div>
                            <ng-container *ngTemplateOutlet="utilityMetricTable; context: {predictions: data2.synthetic.predictions}">
                            </ng-container>
                        </div>
                        <div class="predictions">
                            <div>
                                <div>Difference</div>
                            </div>
                            <ng-container *ngTemplateOutlet="utilityMetricTable; context: {predictions: data2.difference.predictions}">
                            </ng-container>
                        </div>
                    </div>
                    <div *ngIf="(abc.value | instanceOf:UtilityMetricData3) as data3">
                        <ng-container *ngTemplateOutlet="utilityMetricTable; context: {predictions: data3.predictions}">
                        </ng-container>
                    </div>
                </div>
            </div>

        </mat-expansion-panel>
    </mat-accordion>

</div>

<ng-template #utilityMetricTable let-predictions="predictions">
    <div *ngIf="(predictions | instanceOf:UtilityData) as p"
         style="display: flex; flex-direction: row; width: 100%; justify-content: space-between;">
        <div>
            <div class="classifier-cell classifier-head">Classifier</div>
            <ng-container *ngFor="let firstClassifier of getFirstElement(p)">
                <div class="classifier-cell">{{ firstClassifier.classifier }}</div>
            </ng-container>
        </div>

        <div *ngFor="let classifiers of p | keyvalue">
            <div class="classifier-cell classifier-head">{{ classifiers.key }}</div>
            <div *ngFor="let classifier of classifiers.value" class="classifier-cell">

                <span class="metric-similarity"
                     [style.background-color]="statisticsService.colors[classifier.color_index]">
                </span>
                <span>{{ statisticsService.formatNumber(classifier.score) }}</span>
            </div>

        </div>
    </div>
</ng-template>

<app-metric-info-table #metricInfoTableComponent></app-metric-info-table>

<mat-menu #colorLegend="matMenu" xPosition="before" yPosition="below">
    <app-color-legend></app-color-legend>
</mat-menu>
