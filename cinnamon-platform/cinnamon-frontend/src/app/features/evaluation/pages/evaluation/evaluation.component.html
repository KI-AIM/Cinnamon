<ng-container *ngIf="pageData$ | async as pageData">

    <div *ngIf="pageData.stage as status" class="stage-head">
        <button type="submit" mat-raised-button color="primary"
                [disabled]="status.status === ProcessStatus.SCHEDULED || status.status === ProcessStatus.RUNNING || pageData.locked"
                (click)="evaluationService.start(null);">
            Start
            <mat-icon fontIcon="play_arrow"></mat-icon>
        </button>

        <button type="submit" mat-raised-button color="warn"
                [disabled]="!(status.status === ProcessStatus.SCHEDULED || status.status === ProcessStatus.RUNNING)"
                (click)="evaluationService.cancel()">
            Cancel
            <mat-icon fontIcon="stop"></mat-icon>
        </button>

        <span class="status" [ngClass]="status.status">
            <span>{{ status.status.replace("_", " ") }}</span>
        </span>
    </div>

    <div class="stage-tree">

        <!-- Steps on the right -->
        <div class="stage-tree-steps">
            <div *ngFor="let job of pageData.stageDefinition?.jobs; let i = index" class="stage-tree-step">

                <div class="step">
                    <div class="step-lines">
                        <div class="step-horizontal-line-wrapper">
                            <div class="step-horizontal-line"
                                 [ngClass]="evaluationService.getLineClass(pageData.stage, i,  'top')">
                            </div>
                        </div>
                        <div class="step-vertical-alignment">
                            <div class="step-vertical-relative">
                                <div class="step-vertical-line-wrapper step-vertical-line-wrapper-top">
                                    <div class="step-vertical-line"
                                         [ngClass]="evaluationService.getLineClass(pageData.stage, i,  'top')">
                                    </div>
                                </div>
                                <div class="step-vertical-line-wrapper step-vertical-line-wrapper-bottom">
                                    <div class="step-vertical-line"
                                         [ngClass]="evaluationService.getLineClass(pageData.stage, i,  'bottom')">
                                    </div>
                                </div>
                                <div class="step-circle-wrapper">
                                    <div class="step-circle"
                                         [ngClass]="evaluationService.getLineClass(pageData.stage, i,  'top')">
                                        <div class="step-number">
                                            {{ i + 1 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Wrapper for step -->
                    <div class="mb-2 box step-wrapper">
                        <!-- Head -->
                        <div class="step-head">
                            <span> {{ getJobName(job) }} </span>
                            <span>
                            <a *ngIf="pageData.stage != null &&
                                      pageData.stage.status !== ProcessStatus.SCHEDULED &&
                                      pageData.stage.status !== ProcessStatus.RUNNING &&
                                      pageData.stage.status !== ProcessStatus.NOT_STARTED &&
                                      (pageData.stage.status !== ProcessStatus.OUTDATED ||
                                        (i != 0 && pageData.stage.processes[i-1].externalProcessStatus !== ProcessStatus.OUTDATED)) &&
                                      pageData.stage.processes[i].externalProcessStatus !== ProcessStatus.NOT_STARTED &&
                                      !pageData.locked;
                                      else disabledStart"
                               title="Start" (click)="evaluationService.start(job);" class="icon-enabled">
                                <mat-icon fontIcon="play_arrow" style="color: green;"></mat-icon>
                            </a>
                            <ng-template #disabledStart>
                                <span title="Start" class="icon-disabled">
                                    <mat-icon fontIcon="play_arrow"></mat-icon>
                                </span>
                            </ng-template>
                        </span>
                            <span *ngIf="pageData.stage && pageData.stage.processes[i] as process" class="status"
                                  [ngClass]="process.externalProcessStatus">
                            <span>{{ process.externalProcessStatus.replace("_", " ") }}</span>
                        </span>
                        </div>

                        <div class="step-body">
                            <mat-accordion>
                                <!-- Status -->
                                <mat-expansion-panel #statusPanel>
                                    <mat-expansion-panel-header>
                                        <mat-panel-title>Status</mat-panel-title>
                                        <mat-panel-description></mat-panel-description>
                                    </mat-expansion-panel-header>

                                    <div *ngIf="pageData.stage && pageData.stage.processes[i].status as status; else noStatus">
                                        {{ status }}
                                    </div>
                                    <ng-template #noStatus>
                                        <div>
                                            No Status Available
                                        </div>
                                    </ng-template>
                                </mat-expansion-panel>

                                <ng-container *ngIf="job === 'technical_evaluation'">

                                    <ng-container *ngIf="pageData.stage && pageData.stage.processes[i].externalProcessStatus === ProcessStatus.FINISHED && (statistics$ | async) as statistics">

                                        <mat-expansion-panel>
                                            <mat-expansion-panel-header>
                                                <mat-panel-title>{{ statistics.statistics!.resemblance.display_name }}</mat-panel-title>
                                                <mat-panel-description>{{ statistics.statistics!.resemblance.description }}</mat-panel-description>
                                            </mat-expansion-panel-header>

                                            <div>
                                                <app-data-inspection sourceProcess="TECHNICAL_EVALUATION"
                                                                     mainData="synthetic"
                                                                     [processingSteps]="pageData.stage.processes[i].processSteps"></app-data-inspection>
                                            </div>

                                        </mat-expansion-panel>

                                        <mat-expansion-panel *ngIf="statistics.statistics!.utility as utility">
                                            <mat-expansion-panel-header>
                                                <mat-panel-title>{{ utility.display_name }}</mat-panel-title>
                                                <mat-panel-description>{{ utility.description }}</mat-panel-description>
                                            </mat-expansion-panel-header>

                                            <app-data-inspection-utility [metrics]="utility.methods">
                                            </app-data-inspection-utility>

                                        </mat-expansion-panel>

                                    </ng-container>
                                </ng-container>

                                <ng-container *ngIf="job === 'risk_evaluation'">

                                    <mat-expansion-panel>
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>Risks</mat-panel-title>
                                            <mat-panel-description>Risk assessment</mat-panel-description>
                                        </mat-expansion-panel-header>

                                        <ng-container *ngIf="pageData.stage && pageData.stage.processes[i].externalProcessStatus === ProcessStatus.FINISHED && (risks$ | async) as risks; else noRisks">
                                            <app-data-inspection-risks [risks]="risks"></app-data-inspection-risks>
                                        </ng-container>
                                        <ng-template #noRisks>
                                            No Data Available
                                        </ng-template>
                                    </mat-expansion-panel>
                                </ng-container>

                                <ng-container *ngIf="job === 'risk_evaluation_o'">
                                    <mat-expansion-panel>
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>Risks</mat-panel-title>
                                            <mat-panel-description>Risk assessment</mat-panel-description>
                                        </mat-expansion-panel-header>
                                        The privacy score can be viewed in the report.
                                    </mat-expansion-panel>
                                </ng-container>

                                <ng-container *ngIf="job === 'base_evaluation'">
                                    <mat-expansion-panel>
                                        <mat-expansion-panel-header>
                                            <mat-panel-title>Risks</mat-panel-title>
                                            <mat-panel-description>Base assessment</mat-panel-description>
                                        </mat-expansion-panel-header>

                                        <div
                                            *ngIf="pageData.stage && pageData.stage.processes[i].externalProcessStatus === ProcessStatus.FINISHED && (risks2$ | async) as risks; else noRisks2">
                                            {{ risks }}
                                        </div>
                                        <ng-template #noRisks2>
                                            No Data Available
                                        </ng-template>

                                    </mat-expansion-panel>
                                </ng-container>

                            </mat-accordion>

                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <div class="box" *ngIf="pageData.stage as status">
        <button type="button" mat-raised-button color="primary" [disabled]="status.status != ProcessStatus.FINISHED"
                (click)="continue()">
            Continue
        </button>
    </div>

</ng-container>
