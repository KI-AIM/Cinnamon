<ng-container *ngIf="pageData$ | async as pageData">

    <ng-container *ngIf="pageData.status.mode === Mode.STANDARD">

        <app-workstep-list confirmLabel="Confirm file and start configuration" [locked]="pageData.locked.isLocked"
                           [invalid]="isInvalid || loadingEstimation"
                           [numberSteps]="2" resetSteps [step]="Steps.UPLOAD" (confirm)="uploadFile()">

            <app-workstep-item header="Select your dataset" [locked]="pageData.locked.isLocked"
                               [invalid]="isDataFileInvalid || isFileConfigurationInvalid() || loadingEstimation"
                               [stepIndex]="0">
            <ng-container *ngTemplateOutlet="dataFileUpload"></ng-container>
                <ng-container *ngTemplateOutlet="info"></ng-container>
            </app-workstep-item>

            <app-workstep-item header="Select a data configuration if available" [locked]="pageData.locked.isLocked"
                               [invalid]="isConfigFileInvalid" [stepIndex]="1"
                               altConfirm="Continue without a configuration">
                <ng-container *ngTemplateOutlet="configFileUpload"></ng-container>
            </app-workstep-item>

        </app-workstep-list>

    </ng-container>

    <ng-container *ngIf="pageData.status.mode === Mode.EXPERT">

        <app-workstep-box header="Upload your dataset and data configuration">
            <div>
                <ng-container *ngTemplateOutlet="dataFileUpload"></ng-container>
            </div>

            <div class="mt-4">
                <ng-container *ngTemplateOutlet="configFileUpload"></ng-container>
            </div>

            <div class="mt-4">
                <div *ngIf="isFileConfigurationInvalid()" class="cinnamon-error">
                    Please correct the errors in the file configuration.
                </div>
                <button mat-raised-button color="primary" (click)="uploadFile()"
                        [disabled]="isInvalid || loadingEstimation">
                    Confirm file and start configuration
                </button>
            </div>

            <ng-container *ngTemplateOutlet="info"></ng-container>
        </app-workstep-box>

    </ng-container>

    <ng-template #dataFileUpload>
        <ng-container *ngIf="pageData.fileInfo.name !== null; else noFile">
            <span>You previously uploaded the file: </span>
            <span>{{ pageData.fileInfo.name }}</span><br/>
            <span *ngIf="!pageData.locked.isLocked">You can select another dataset by uploading a new file:</span>
            <span *ngIf="pageData.locked.isLocked">You already confirmed the dataset. If you want to select another dataset, you have to delete the current dataset on the "Data validation" page first.</span>
        </ng-container>
        <ng-template #noFile>
            Select the file containing the dataset you want to anonymize:
        </ng-template>

        <div class="mt-2">
            <div class="d-flex align-items-center w-100">
                <app-file-upload accept=".csv,.json,.xlsx" [disabled]="pageData.locked.isLocked"
                                 (input)="onFileInput($event)" class="flex-grow-1"></app-file-upload>

                <div *ngIf="loadingEstimation" class="ms-1">
                    <mat-spinner [diameter]="24"></mat-spinner>
                </div>
                <div *ngIf="!loadingEstimation" class="ms-1">
                    <a *ngIf="!isDataFileInvalid" title="Additional Settings"
                       (click)="openDialog(fileConfigurationDialog)" class="icon icon-enabled"
                       [class.icon-error]="isFileConfigurationInvalid()">
                        <mat-icon fontIcon="settings"></mat-icon>
                        <div class="icon-error-background"></div>
                        <mat-icon fontIcon="error" class="icon-error-foreground"></mat-icon>
                    </a>
                    <span *ngIf="isDataFileInvalid" title="Additional Settings" class="icon-disabled">
                        <mat-icon fontIcon="settings"></mat-icon>
                    </span>
                </div>

            </div>
        </div>
    </ng-template>

    <ng-template #configFileUpload>
        If you already have a configuration file, you can upload it here.
        If not, you can continue without a configuration and a data configuration will be estimated based on the
        selected dateset.

        <div class="mt-2">
            <app-file-upload accept=".yml,.yaml" [disabled]="pageData.locked.isLocked"
                             (input)="onDataConfigurationFileInput($event)"></app-file-upload>
        </div>
    </ng-template>

    <ng-template #info>
        <div>
            <p>
                <b>Supported File Types:</b>
                <br/>
                Ensure your files are in a supported format. You'll be notified if the file type is not accepted. <br/>
                Supported file types are:
            </p>
            <ul>
                <li>CSV Files</li>
                <li>XLSX Files</li>
                <li>FHIR Bundles</li>
            </ul>
            FHIR support is under development and will be available soon.<br/><br/>

            <p>
                <b>File Size Limit:</b>
                <br/>
                <ng-container *ngIf="pageData.appConfig.maxFileSize >= 0 else noFileSizeLimit">
                    The maximum file size is {{ formatMaxFileSize(pageData.appConfig.maxFileSize) }}.
                    Most algorithms by this application take a long time to process.
                    To ensure that processing times are somewhat reasonable, we have to limit the dataset size.
                </ng-container>
                <ng-template #noFileSizeLimit>
                    There is no limit for the file size.
                    But be aware that processing times can be long for large datasets.
                </ng-template>
                <br/><br/>
                <b>Upload Progress:</b>
                <br/>
                Once you've selected your file, the upload process will begin. You will see a loading screen.
                Before saving the data, the application will transform and validate it.
                The validation results will be shown after the process is finished.
                <br/><br/>
                <b>Security:</b>
                <br/>
                Your files are transmitted securely using encryption protocols to protect your data.
                The data never leaves the system where the Cinnamon application is installed.
                The processed data will also only be accessible to the user that uploaded the data and will be deleted
                after the process was finished.
            </p>
        </div>
    </ng-template>

    <ng-template #fileConfigurationDialog>
        <mat-dialog-content class="mat-typography">
            <h1>Configure the file</h1>
            <div *ngIf="this.fileConfiguration.fileType === FileType.CSV">
                <div>
                    <mat-form-field class="d-block">
                        <mat-label>Column Separator</mat-label>
                        <mat-select [(ngModel)]="this.fileConfiguration.csvFileConfiguration.columnSeparator">
                            <mat-option *ngFor="let delimiter of delimiters" [value]="delimiter">
                                {{ delimiterLabels[delimiter] }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field class="d-block">
                        <mat-label>Line break</mat-label>
                        <mat-select [(ngModel)]="this.fileConfiguration.csvFileConfiguration.lineSeparator">
                            <mat-option *ngFor="let lineEnd of lineEndings" [value]="lineEnd">
                                {{ lineEndingLabels[lineEnd] }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field class="d-block">
                        <mat-label>Quote Char</mat-label>
                        <mat-select [(ngModel)]="this.fileConfiguration.csvFileConfiguration.quoteChar">
                            <mat-option *ngFor="let quoteChar of quoteChars" [value]="quoteChar">
                                {{ quoteCharLabels[quoteChar] }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div>
                    <mat-checkbox [(ngModel)]="this.fileConfiguration.csvFileConfiguration.hasHeader" color="primary">
                        Use first row as header
                    </mat-checkbox>
                </div>
            </div>
            <div *ngIf="this.fileConfiguration.fileType === FileType.XLSX">
                <div>
                    <mat-checkbox [(ngModel)]="this.fileConfiguration.xlsxFileConfiguration.hasHeader" color="primary">
                        Use first row as header
                    </mat-checkbox>
                </div>
            </div>
            <div *ngIf="this.fileConfiguration.fileType === FileType.FHIR">
                <div>
                    <div class="config-input-row">
                        <mat-form-field class="config-input-row-field">
                            <mat-label>FHIR Resource Type</mat-label>
                            <mat-select [(ngModel)]="this.fileConfiguration.fhirFileConfiguration.resourceType" required>
                                <mat-option *ngFor="let option of fhirResourceTypes" [value]="option">
                                    {{ option }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <div class="config-input-row-info">
                            <span>
                                <app-configuration-input-info [configurationInputDefinition]="fhirResourceTypeDefinition">
                                </app-configuration-input-info>
                            </span>
                        </div>

                    </div>
                </div>
            </div>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-raised-button mat-dialog-close color="primary">Close</button>
        </mat-dialog-actions>
    </ng-template>

</ng-container>
