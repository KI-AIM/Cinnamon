<ng-container *ngIf="pageData$ | async as data">
    <ng-container *ngIf="data.status.mode === Mode.STANDARD">

        <app-workstep-list confirmLabel="Confirm configuration" [locked]="data.locked" [numberSteps]="4"
                           [step]="step" [invalid]="oneEnabled && !formValid" (confirm)="submit()">
            <!-- Activation -->
            <app-workstep-item header="Select steps to execute" [locked]="data.locked" [stepIndex]="0"
                               [invalid]="!oneEnabled" altConfirm="Skip all steps" [altConfirmAll]="true"
                               [altConfirmValid]="!oneEnabled">
                <ng-container *ngTemplateOutlet="processActivation"></ng-container>
            </app-workstep-item>

            <!-- Upload -->
            <app-workstep-item header="Upload a configuration if available" [locked]="data.locked"
                               [stepIndex]="1" altConfirm="Continue witout a configuraiton"
                               [invalid]="configFileCache === null" (confirm)="uploadCachedConfiguration()">
                Upload an existing configuration:
                <app-file-upload accept=".yml,.yaml" [disabled]="data.locked || !oneEnabled"
                                 (input)="cacheConfiguration($event)"></app-file-upload>
            </app-workstep-item>

            <!-- Algorithm Selection -->
            <app-workstep-item header="Select the algorithm to be executed" [locked]="data.locked"
                               [stepIndex]="2" [invalid]="selectedAlgorithm == null">
                <app-configuration-selection #selection [algorithms]="algorithms"
                                             [disabled]="data.locked || !oneEnabled"
                                             [initialValue]="data.configurationData.selectedAlgorithm"
                                             (change)="onSelectionChange($event)">
                </app-configuration-selection>
            </app-workstep-item>

            <!-- Algorithm Configuration -->
            <app-workstep-item header="Configure the selected algorithm" [locked]="data.locked"
                               [stepIndex]="3" [invalid]="!formValid">
                <div *ngIf="!selectedAlgorithm; else configurationForms" id="placeholder" class="w-100 mt-4">
                    <div class="ms-auto me-auto" style="width: fit-content">
                        Please select an algorithm in the previous step first.
                    </div>
                </div>
                <ng-template #configurationForms>
                    <div *ngFor="let item of algorithms" [id]="item">
                        <ng-container *ngIf="selectedAlgorithm != null && selectedAlgorithm.name === item.name">
                            <p>{{ item.description }}</p>

                            <app-configuration-form #form [algorithm]="item"
                                                    [disabled]="data.locked || !oneEnabled"
                                                    (onChange)="onFormChange($event)"
                                                    [additionalConfigs]="additionalConfigs">
                            </app-configuration-form>
                        </ng-container>
                    </div>
                </ng-template>
            </app-workstep-item>

        </app-workstep-list>

    </ng-container>

    <ng-container *ngIf="data.status.mode === Mode.EXPERT">

        <app-workstep-box header="Process Activation">
            <ng-container *ngTemplateOutlet="processActivation"></ng-container>
        </app-workstep-box>

        <app-workstep-box header="Configuration Upload">
            Upload an existing configuration:
            <app-file-upload accept=".yml,.yaml" [disabled]="data.locked || !oneEnabled"
                             (input)="uploadConfiguration($event)"></app-file-upload>
        </app-workstep-box>

        <app-workstep-box header="Algorithm Selection" [class.d-none]="!hasAlgorithmSelection">
            <app-configuration-selection #selection [algorithms]="algorithms"
                                         [initialValue]="data.configurationData.selectedAlgorithm"
                                         [disabled]="data.locked || !oneEnabled"
                                         (change)="onSelectionChange($event)">
            </app-configuration-selection>
        </app-workstep-box>

        <app-workstep-box header="Algorithm Configuration" [invalid]="selectedAlgorithm !== null && !formValid">
            <div *ngIf="!selectedAlgorithm; else configurationForms" id="placeholder" class="w-100 mt-4">
                <div class="ms-auto me-auto" style="width: fit-content">
                    Please select an algorithm
                </div>
            </div>
            <ng-template #configurationForms>
                <div *ngFor="let item of algorithms" [id]="item">
                    <ng-container *ngIf="selectedAlgorithm!.name === item.name">
                        <p>{{ item.description }}</p>

                        <app-configuration-form #form [additionalConfigs]="additionalConfigs" [algorithm]="item"
                                                [disabled]="data.locked || !oneEnabled"
                                                (onChange)="onFormChange($event)"
                        >
                        </app-configuration-form>
                    </ng-container>
                </div>
            </ng-template>
        </app-workstep-box>

        <app-workstep-box header="Confirm your configuration">
            <button type="submit" mat-raised-button color="primary"
                    [disabled]="data.locked || (oneEnabled && !formValid)" (click)="submit()">
                Continue
            </button>
        </app-workstep-box>

    </ng-container>

    <ng-template #processActivation>
        <ng-container *ngFor="let process of configurationInfo.processes;">
            <div class="d-flex">
                <mat-checkbox color="primary" [(ngModel)]="processEnabled[process.job]"
                              [disabled]="data.locked || !process.holdOutFulfilled"
                              (input)="updateOneEnabled()">
                    Run {{ jobLabels[process.job] }}
                </mat-checkbox>
                <ng-container *ngIf="!process.holdOutFulfilled">
                        <span class="ms-1 my-auto">
                            <mat-icon fontIcon="warning" class="warn-icon"
                                      matTooltip="This step requires extended analysis to be enabled."
                                      matTooltipPosition="right"></mat-icon>
                        </span>
                </ng-container>
            </div>
        </ng-container>
    </ng-template>

</ng-container>
